# healthya_line_campaign

This project contains source code and supporting files for a serverless application that you can deploy with the AWS Serverless Application Model (AWS SAM) command line interface (CLI). It includes the following files and folders:

- `src` - Code for the application's Lambda function.
- `events` - Invocation events that you can use to invoke the function.
- `__tests__` - Unit tests for the application code.
- `template.yml` - A template that defines the application's AWS resources.
- `env.json` - Environment valiable of Lambda function.
- `docker-compose.yml` - Mysql environment configuration file using Docker.
- `database.json` - Database connection information.
- `built` - Output directory after build.
- `client` - Front-end directory.

## Setup AWS SAM Environment

To use the AWS SAM CLI, you need the following tools:

* AWS SAM CLI - [Install the AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html).
* AWS CLI - [Install the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html) and [configure it with your AWS credentials](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html).
* Node.js - [Install Node.js 10](https://nodejs.org/en/), including the npm package management tool.
* Docker - [Install Docker community edition](https://hub.docker.com/search/?type=edition&offering=community).

## Setup AWS credential

* AWS credential information - [AWS credential(ACCESS Works)](https://acsmine.tok.access-company.com/redmine/projects/kao_health_dev/wiki/%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83#AWS-credentialACCESS-Works)

```bash
$aws configure
$AWS Access Key ID: (Enter aws access key id)
$AWS Secret Access Key: (Enter aws secret access key)
$Default region name [ap-northeast-1]: ap-northeast-1
$Default output format [json]: json
```

## How to start local server

### Install npm libraries

```bash
$ npm install
$ npm install -g sequelize
```

### Start MySQL(Docker)

```bash
$ docker network create lambda-local # for the first time only
$ docker-compose up -d
```

### Create table and migration

```bash
$ sequelize db:create # for the first time only
$ sequelize db:migrate --env development
```

### Start SAM local server(API Server)

```bash
$ npm run build:dev # If you use LINE login, build command is `npm run build`
$ sam local start-api --env-vars env.json --docker-network lambda-local
```

## Develop MySQL table

### Create database migration file

$ sequelize migration:generate --name `name`

### Database migration

$ sequelize db:migrate --env development

### Database migration rollback

$ sequelize db:migrate:undo --env development

## Unit tests

Tests are defined in the `__tests__` folder in this project. Use `npm` to install the [Jest test framework](https://jestjs.io/) and run unit tests.

```bash
$ npm install
$ npm run test
```

## Deploy the application

To prepare the application for deployment, use the `sam package` command.

```bash
$ sam package \
    --output-template-file packaged.yaml \
    --s3-bucket BUCKET_NAME
```

The AWS SAM CLI creates deployment packages, uploads them to the S3 bucket, and creates a new version of the template that refers to the artifacts in the bucket. 

To deploy the application, use the `sam deploy` command.

```bash
$ sam deploy \
    --template-file packaged.yaml \
    --stack-name sam-app \
    --capabilities CAPABILITY_IAM
```

After deployment is complete, you can run the following command to retrieve the API Gateway endpoint URL:

```bash
$ aws cloudformation describe-stacks \
    --stack-name sam-app \
    --query 'Stacks[].Outputs[?OutputKey==`WebEndpoint`]' \
    --output table
``` 

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, the AWS SAM CLI has a command called `sam logs`. `sam logs` lets you fetch logs that are generated by your Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

**NOTE:** This command works for all Lambda functions, not just the ones you deploy using AWS SAM.

```bash
$ sam logs -n putItemFunction --stack-name sam-app --tail
```

## Cleanup

To delete the sample application and the bucket that you created, use the AWS CLI.

```bash
$ aws cloudformation delete-stack --stack-name sam-app
$ aws s3 rb s3://BUCKET_NAME
```

## Resources

For an introduction to the AWS SAM specification, the AWS SAM CLI, and serverless application concepts, see the [AWS SAM Developer Guide](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html).
